<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout :: content(~{::section})}">

<head>
    <title>Support</title>
</head>

<body>
<section class="fade-in">

    <!-- PAGE HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 mb-0 text-gray-800 fw-bold">Support Tickets</h2>
        <a th:href="@{/support/create}"
           class="btn btn-warning shadow-sm fw-bold"
           sec:authorize="hasAnyRole('EVENT_MANAGER', 'CUSTOMER')">
            <i class="fas fa-plus fa-sm me-2"></i>New Ticket
        </a>
    </div>

    <!-- SEARCH & FILTER -->
    <div class="card shadow-sm border-0 mb-4 rounded-4">
        <div class="card-body">
            <form th:action="@{/support}" method="get" class="row g-3 align-items-end">

                <div class="col-md-4">
                    <label class="form-label fw-bold text-muted">Search</label>
                    <input type="text" name="search" class="form-control"
                           th:value="${currentSearch}"
                           placeholder="Search by username, issue type, status, or description...">
                </div>

                <div class="col-md-2">
                    <label class="form-label fw-bold text-muted">Status</label>
                    <select name="status" class="form-select">
                        <option value="" th:selected="${currentStatus == null || currentStatus == ''}">All Status</option>
                        <option value="OPEN" th:selected="${currentStatus == 'OPEN'}">Open</option>
                        <option value="RESOLVED" th:selected="${currentStatus == 'RESOLVED'}">Resolved</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label fw-bold text-muted">Sort By</label>
                    <select name="sortBy" class="form-select">
                        <option value="ticketId" th:selected="${sortBy == 'ticketId'}">Ticket ID</option>
                        <option value="createdDate" th:selected="${sortBy == 'createdDate'}">Created Date</option>
                        <option value="ticketStatus" th:selected="${sortBy == 'ticketStatus'}">Status</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label fw-bold text-muted">Order</label>
                    <select name="sortDir" class="form-select">
                        <option value="desc" th:selected="${sortDir == 'desc'}">Descending</option>
                        <option value="asc" th:selected="${sortDir == 'asc'}">Ascending</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label fw-bold text-muted">Page Size</label>
                    <select name="size" class="form-select">
                        <option value="5" th:selected="${size == 5}">5</option>
                        <option value="10" th:selected="${size == 10}">10</option>
                        <option value="20" th:selected="${size == 20}">20</option>
                        <option value="50" th:selected="${size == 50}">50</option>
                    </select>
                </div>

                <div class="col-md-12">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-search me-1"></i>Search
                    </button>
                    <a th:href="@{/support}" class="btn btn-secondary">
                        <i class="fas fa-redo me-1"></i>Reset
                    </a>
                </div>

                <input type="hidden" name="page" value="0"/>
            </form>
        </div>
    </div>

    <!-- SUCCESS / ERROR -->
    <div th:if="${success}" class="alert alert-success shadow-sm border-0">
        <i class="fas fa-check-circle me-2"></i>
        <span th:text="${success}"></span>
    </div>

    <div th:if="${error}" class="alert alert-danger shadow-sm border-0">
        <i class="fas fa-exclamation-circle me-2"></i>
        <span th:text="${error}"></span>
    </div>

    <!-- TABLE CARD (FIXED) -->
    <div class="card shadow border-0 rounded-4 overflow-hidden">
        <div class="card-body">

            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-primary">
                    <tr>
                        <th>S.No</th>
                        <th>ID</th>
                        <th>Issue</th>
                        <th>Category</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Resolution Notes</th>
                        <th sec:authorize="hasAnyRole('ADMIN', 'EVENT_MANAGER')">Action</th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr th:each="ticket, stat : ${tickets}">
                        <td class="text-muted"
                            th:text="${((currentPage != null ? currentPage : 0) * (size != null ? size : 10)) + stat.count}">
                        </td>

                        <td class="fw-bold" th:text="${ticket.ticketId}"></td>
                        <td th:text="${ticket.issueDescription}"></td>

                        <td>
                            <span class="badge bg-light text-dark border fw-normal"
                                  th:text="${ticket.issueType != null ? ticket.issueType : 'Others'}">
                            </span>
                        </td>

                        <td>
                            <span class="badge rounded-pill"
                                  th:classappend="${ticket.ticketStatus == 'OPEN' ? 'bg-warning' : 'bg-success'}"
                                  th:text="${ticket.ticketStatus}">
                            </span>
                        </td>

                        <td class="small text-muted"
                            th:text="${#temporals.format(ticket.createdDate, 'yyyy-MM-dd HH:mm')}">
                        </td>

                        <td>
                            <div th:if="${ticket.resolutionNotes != null && !ticket.resolutionNotes.isEmpty()}"
                                 class="text-muted small">
                                <i class="fas fa-check-circle text-success me-1"></i>
                                <span th:text="${ticket.resolutionNotes}"></span>
                            </div>

                            <span th:if="${ticket.resolutionNotes == null || ticket.resolutionNotes.isEmpty()}"
                                  class="text-muted small">-</span>
                        </td>

                       <td><a th:if="${ticket.ticketStatus == 'OPEN'}"
									sec:authorize="hasRole('ADMIN')"
									th:href="@{/support/resolve/{id}(id=${ticket.ticketId})}"
									class="btn btn-sm btn-success shadow-sm">Resolve</a> <a
									th:if="${ticket.ticketStatus == 'OPEN' && ticket.customer.role.name() != 'EVENT_MANAGER'}"
									sec:authorize="hasRole('EVENT_MANAGER')"
									th:href="@{/support/resolve/{id}(id=${ticket.ticketId})}"
									class="btn btn-sm btn-success shadow-sm">Resolve</a></td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(tickets)}">
                        <td colspan="8" class="text-center py-5 text-muted">
                            No tickets found.
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- FOOTER (INSIDE CARD â€“ FIXED) -->
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div class="text-muted">
                    Showing <span th:text="${#lists.size(tickets)}">0</span>
                    of <span th:text="${totalElements}">0</span> tickets
                </div>

                <nav th:if="${totalPages > 1}" aria-label="Page navigation">
                    <ul class="pagination justify-content-center mb-0">
                        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                            <a class="page-link"
                               th:href="@{/support(page=${currentPage - 1}, size=${size}, sortBy=${sortBy}, sortDir=${sortDir}, status=${currentStatus}, search=${currentSearch})}">
                                Previous
                            </a>
                        </li>

                        <li class="page-item"
                            th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                            th:classappend="${currentPage == i} ? 'active'">
                            <a class="page-link"
                               th:href="@{/support(page=${i}, size=${size}, sortBy=${sortBy}, sortDir=${sortDir}, status=${currentStatus}, search=${currentSearch})}"
                               th:text="${i + 1}">
                            </a>
                        </li>

                        <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                            <a class="page-link"
                               th:href="@{/support(page=${currentPage + 1}, size=${size}, sortBy=${sortBy}, sortDir=${sortDir}, status=${currentStatus}, search=${currentSearch})}">
                                Next
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>

        </div>
    </div>

</section>
</body>
</html>
